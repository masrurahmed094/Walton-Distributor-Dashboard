<div class="dashboard-container">
  <!-- FILTERS -->
  <div class="filters-container">
    <div class="filter-group">
      <label for="distributor-select">Distributor</label>
      <ng-select
        id="distributor-select"
        [items]="(distributors$ | async) ?? []"
        bindLabel="name"
        placeholder="Search by Distributor Name or Code"
        [searchable]="true"
        [searchFn]="customSearchFn"
        (change)="onDistributorChange($event)">
      </ng-select>
    </div>
    <div class="filter-group">
      <label>Date Range</label>
      <div class="date-range">
        <input #startDate type="date" (change)="onDateRangeChange(startDate.value, endDate.value)">
        <span>to</span>
        <input #endDate type="date" (change)="onDateRangeChange(startDate.value, endDate.value)">
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <ng-container *ngIf="hasInitialFilters$ | async">
    <!-- KPI Grid -->
    <div class="kpi-grid">
      <app-kpi-card title="Lifting/Target" format="currency" [data]="(kpiData$ | async)?.liftingTarget" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.target"></app-kpi-card>
      <app-kpi-card title="Purchase Amount" format="currency" [data]="(kpiData$ | async)?.purchaseAmount" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.purchase"></app-kpi-card>
      <app-kpi-card
        title="Monthly IMS"
        format="currency"
        [data]="(kpiData$ | async)?.imsInvoiced"
        [isLoading]="isLoading.kpis"
        [iconSvgPath]="icons.ims"
        [progressTotal]="(kpiData$ | async)?.imsTarget?.amount ?? null">
      </app-kpi-card>
      <app-kpi-card title="Monthly Collection" format="currency" [data]="(kpiData$ | async)?.monthlyCollection" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.collection"></app-kpi-card>
      <app-kpi-card title="Primary Order" format="currency" [data]="(kpiData$ | async)?.primaryOrder" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.primaryOrder"></app-kpi-card>
      <app-kpi-card title="Secondary Order" format="currency" [data]="(kpiData$ | async)?.secondaryOrder" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.secondaryOrder"></app-kpi-card>
      <app-kpi-card title="Current Stock" format="currency" [data]="(kpiData$ | async)?.currentStock" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.currentStock"></app-kpi-card>
      <app-kpi-card title="Total Active Customers" format="number" [data]="(kpiData$ | async)?.totalActiveCustomers" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.activeCustomers"></app-kpi-card>
      <app-kpi-card title="Total Invoiced Customers" format="number" [data]="(kpiData$ | async)?.totalInvoicedCustomers" [isLoading]="isLoading.kpis" [iconSvgPath]="icons.invoicedCustomers"></app-kpi-card>
    </div>

    <!-- Main Grid for Charts and Tables -->
    <div class="main-grid">
      <div class="chart-area">
        <div *ngIf="isLoading.historicalData" class="skeleton-loader chart-skeleton"></div>
        <ng-container *ngIf="!isLoading.historicalData">
          <app-historical-chart [chartData]="(historicalData$ | async) ?? []"></app-historical-chart>
        </ng-container>
      </div>
      <div class="table-area">
        <div *ngIf="isLoading.srPerformance" class="skeleton-loader table-skeleton"></div>
        <ng-container *ngIf="!isLoading.srPerformance">
          <app-sr-performance-table [performanceData]="(srPerformance$ | async) ?? []"></app-sr-performance-table>
        </ng-container>
      </div>
       <div class="full-width-area">
        <div *ngIf="isLoading.distributorReport" class="skeleton-loader table-skeleton"></div>
        <ng-container *ngIf="!isLoading.distributorReport">
          <app-distributor-report [reportData]="(distributorReport$ | async) ?? []"></app-distributor-report>
        </ng-container>
      </div>
    </div>
  </ng-container>

  <!-- Welcome Message -->
  <div *ngIf="!(hasInitialFilters$ | async)" class="initial-message">
    <h2>Welcome to the Distributor Dashboard</h2>
    <p>Please select a distributor to view their data.</p>
  </div>
</div>

